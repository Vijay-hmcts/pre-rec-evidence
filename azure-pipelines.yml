---
name: PRE Solution Exporter
trigger: none
pr: none
parameters:
  - name: serviceConnection
    displayName: Service Connection
    type: string
    default: 'POWERAPPS-PRE-SDS-SBOX'
    values:
      - 'POWERAPPS-PRE-SDS-SBOX'
  - name: exportToBranch
    displayName: Export To Branch
    type: string
    default: 'dev'

variables:
  solutionName: dts_pre_recorded_evidence


pool:
  vmImage: 'windows-latest'

steps:

- checkout: self
  persistCredentials: true
  clean: true

- task: PowerPlatformToolInstaller@0
  inputs:
    DefaultVersion: true

- task: PowerPlatformExportSolution@0
  inputs:
    authenticationType: 'PowerPlatformSPN'
    PowerPlatformSPN: ${{ parameters.serviceConnection }}
    SolutionName: $(solutionName)
    SolutionOutputFile: 'dts_pre_recorded_evidence.zip'
    AsyncOperation: false

- task: PowerPlatformUnpackSolution@0
  inputs:
    SolutionInputFile: 'dts_pre_recorded_evidence.zip'
    SolutionTargetFolder: 'src'

- task: CmdLine@2
  inputs:
    script: |
      echo Commit Power Platform Solution
      git config user.email "prebuildpipeline@hmcts.net"
      git config user.name "PRE Build Pipeline"
      git pull origin master
      git checkout -b ${{ parameters.exportToBranch }}
      git add --all
      git commit -m "Automatic solution commit"
      git -c http.extraheader="AUTHORIZATION: bearer $(system.githubPat)" push origin ${{ parameters.exportToBranch }}
